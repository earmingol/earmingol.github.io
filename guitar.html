<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Guitar Fretboard - Learn Scales & Notes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: auto;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #fff, #ffeb3b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }
        
        select, input, button {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        select:hover, input:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #ffeb3b;
            box-shadow: 0 0 0 3px rgba(255, 235, 59, 0.2);
        }
        
        button {
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .tuning-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tuning-inputs input {
            width: 60px;
            text-align: center;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .fretboard-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow-x: auto;
            position: relative;
        }
        
        #fretboard {
            display: block;
            margin: 0 auto;
            cursor: crosshair;
            filter: drop-shadow(0 4px 15px rgba(0,0,0,0.5));
        }
        
        .info-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .selected-note {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffeb3b;
            text-shadow: 0 0 20px rgba(255, 235, 59, 0.5);
        }
        
        .legend {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .legend-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .legend-color {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .legend-color::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: inherit;
            opacity: 0.3;
            filter: blur(5px);
        }
        
        .help-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            transform: rotate(90deg);
            color: #ff5252;
        }
        
        .modal h2 {
            color: #ffeb3b;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        .modal h3 {
            color: #64b5f6;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        .modal p {
            line-height: 1.8;
            opacity: 0.95;
        }
        
        .modal ul {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .modal code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .clear-button {
            background: linear-gradient(135deg, #ff5252 0%, #ff1744 100%);
        }
        
        .highlight-button {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
        }
        
        .language-button {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        }
        
        .invert-button {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .note-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .pulse {
            animation: pulse 0.5s ease-out;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .controls-grid { grid-template-columns: 1fr; }
            .legend { gap: 15px; }
            .help-button { width: 50px; height: 50px; font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Interactive Guitar Fretboard</h1>
            <p class="subtitle">Learn scales, notes, and music theory visually</p>
        </header>
        
        <div class="controls">
            <div class="controls-grid">
                <div class="control-group">
                    <label>Tuning Preset</label>
                    <select id="tuningPreset">
                        <option value="standard">Standard (E-A-D-G-B-E)</option>
                        <option value="dropD">Drop D (D-A-D-G-B-E)</option>
                        <option value="dropC">Drop C (C-G-C-F-A-D)</option>
                        <option value="openG">Open G (D-G-D-G-B-D)</option>
                        <option value="openD">Open D (D-A-D-F#-A-D)</option>
                        <option value="halfStep">Half Step Down (Eb-Ab-Db-Gb-Bb-Eb)</option>
                        <option value="dadgad">DADGAD</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Scale/Mode/Progression</label>
                    <select id="scaleSelect">
                        <option value="none">None - Free Play</option>
                        <optgroup label="Pentatonic Scales">
                            <option value="majorPentatonic">Major Pentatonic</option>
                            <option value="minorPentatonic">Minor Pentatonic</option>
                        </optgroup>
                        <optgroup label="Common Scales">
                            <option value="major">Major Scale (Ionian)</option>
                            <option value="minor">Natural Minor (Aeolian)</option>
                            <option value="blues">Blues Scale</option>
                            <option value="harmonic">Harmonic Minor</option>
                            <option value="melodic">Melodic Minor</option>
                        </optgroup>
                        <optgroup label="Modes">
                            <option value="dorian">Dorian Mode</option>
                            <option value="phrygian">Phrygian Mode</option>
                            <option value="lydian">Lydian Mode</option>
                            <option value="mixolydian">Mixolydian Mode</option>
                            <option value="locrian">Locrian Mode</option>
                        </optgroup>
                        <optgroup label="Chord Progressions">
                            <option value="powerChord">Power Chord (1-5-8)</option>
                            <option value="majorTriad">Major Triad (1-3-5)</option>
                            <option value="minorTriad">Minor Triad (1-b3-5)</option>
                            <option value="seventh">Dominant 7th (1-3-5-b7)</option>
                            <option value="maj7">Major 7th (1-3-5-7)</option>
                            <option value="min7">Minor 7th (1-b3-5-b7)</option>
                        </optgroup>
                        <optgroup label="Intervals">
                            <option value="thirds">Thirds</option>
                            <option value="fourths">Fourths</option>
                            <option value="fifths">Fifths</option>
                            <option value="octaves">Octaves</option>
                        </optgroup>
                        <option value="chromatic">Chromatic (All Notes)</option>
                    </select>
                </div>
                
                <div class="control-group full-width">
                    <label>Custom Tuning (<span id="tuningLabel">1st→6th string</span>)</label>
                    <div class="tuning-inputs">
                        <input type="text" id="string6" value="E" maxlength="3" title="6th string (thickest)">
                        <input type="text" id="string5" value="A" maxlength="3" title="5th string">
                        <input type="text" id="string4" value="D" maxlength="3" title="4th string">
                        <input type="text" id="string3" value="G" maxlength="3" title="3rd string">
                        <input type="text" id="string2" value="B" maxlength="3" title="2nd string">
                        <input type="text" id="string1" value="E" maxlength="3" title="1st string (thinnest)">
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="clearButton" class="clear-button">Clear All</button>
                <button id="highlightRoots" class="highlight-button">Highlight Roots</button>
                <button id="hideExtraRoots" class="highlight-button">Hide Extra Roots</button>
                <button id="languageToggle" class="language-button">Español</button>
                <button id="invertFretboard" class="invert-button">Notation View</button>
            </div>
        </div>
        
        <div class="fretboard-container">
            <canvas id="fretboard"></canvas>
        </div>
        
        <div class="info-panel">
            <div class="selected-note" id="selectedNote">Click any fret to explore</div>
            <div id="noteInfo">Click a note to set it as the root for scales</div>
            <div class="note-info" id="scaleInfo" style="display: none;"></div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #ff5252;"></div>
                <span>Selected Note (Free Play)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #64b5f6;"></div>
                <span>Scale Notes</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffeb3b;"></div>
                <span>Main Root Position</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4caf50;"></div>
                <span>Root Octaves (Free Play)</span>
            </div>
        </div>
    </div>
    
    <div class="help-button" onclick="showHelp()">?</div>
    
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeHelp()">&times;</span>
            <h2>Guitar Fretboard Guide</h2>
            
            <h3>How to Use</h3>
            <ul>
                <li><strong>Click any fret</strong> to see all positions of that note and set it as the root</li>
                <li><strong>Select a scale</strong> to visualize its pattern from your selected root note</li>
                <li><strong>Change tuning</strong> using presets or create your own custom tuning</li>
                <li><strong>Toggle language</strong> between English and Spanish note names</li>
                <li><strong>Switch views</strong> between tablature view (1st string on top) and notation view (6th string on top)</li>
                <li><strong>Hide Extra Roots</strong> to show only the clicked root position as the main root, with other octaves displayed as regular scale notes</li>
            </ul>
            
            <h3>Understanding Scales</h3>
            <p>A scale is a sequence of notes that forms the foundation of melodies and harmonies. When you click a note, it becomes the root (tonic) of whatever scale you select.</p>
            
            <h3>Common Scales Explained</h3>
            <ul>
                <li><strong>Major Pentatonic:</strong> A 5-note scale with a bright, happy sound. Formula: 1-2-3-5-6</li>
                <li><strong>Minor Pentatonic:</strong> A 5-note scale with a bluesy, rock sound. Formula: 1-b3-4-5-b7</li>
                <li><strong>Major Scale:</strong> The foundation of Western music. Formula: W-W-H-W-W-W-H</li>
                <li><strong>Natural Minor:</strong> A darker version of the major scale. Formula: W-H-W-W-H-W-W</li>
                <li><strong>Blues Scale:</strong> Minor pentatonic with an added "blue note". Formula: 1-b3-4-b5-5-b7</li>
            </ul>
            
            <h3>How Root Notes Work</h3>
            <p>The root note is automatically set when you click on any fret. This becomes the starting point (1st degree) for any scale or progression you select. For example:</p>
            <ul>
                <li>Click on the 3rd fret of the A string (C note)</li>
                <li>Select "Major Scale"</li>
                <li>The fretboard will show C Major scale</li>
            </ul>
            
            <h3>Chord Progressions</h3>
            <p>The tool shows chord tones and intervals from your selected root:</p>
            <ul>
                <li><strong>Triads:</strong> Three-note chords (Major: 1-3-5, Minor: 1-b3-5)</li>
                <li><strong>Seventh Chords:</strong> Four-note chords adding color and tension</li>
                <li><strong>Intervals:</strong> The distance between notes (thirds, fourths, fifths, octaves)</li>
            </ul>
            
            <h3>Music Theory Tips</h3>
            <ul>
                <li>Practice scales starting from different positions to learn the entire fretboard</li>
                <li>Notice how patterns repeat - the same shape works in different positions</li>
                <li>The 12th fret is one octave higher than the open string</li>
                <li>Modes are variations of the major scale starting from different degrees</li>
            </ul>
            
            <h3>Spanish Note Names</h3>
            <p>Click the "Español" button to switch between:</p>
            <ul>
                <li>English: C - D - E - F - G - A - B</li>
                <li>Spanish: Do - Re - Mi - Fa - Sol - La - Si</li>
            </ul>
            
            <h3>Root Note Management</h3>
            <p>When visualizing scales, you can control how root notes are displayed:</p>
            <ul>
                <li><strong>Show All Roots:</strong> All positions of the root note are highlighted in yellow with a glow effect</li>
                <li><strong>Hide Extra Roots:</strong> Only the clicked position shows as the main root (yellow). Other root positions are either shown as regular scale notes (blue) if they're part of the scale, or completely hidden if they're not part of the selected scale/mode/progression.</li>
            </ul>
            
            <h3>Fretboard Views</h3>
            <p>Use "Notation View" to toggle between:</p>
            <ul>
                <li><strong>Tablature View:</strong> 1st string (high E) on top - like guitar tabs</li>
                <li><strong>Notation View:</strong> 6th string (low E) on top - like sheet music</li>
            </ul>
            
            <p style="margin-top: 30px; opacity: 0.8; text-align: center;">
                <em>Tip: The selected note always becomes the root for scales and progressions!</em>
            </p>
        </div>
    </div>

    <script>
        // Musical note system
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const noteAliases = {
            'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#',
            'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb',
            'DB': 'C#', 'EB': 'D#', 'GB': 'F#', 'AB': 'G#', 'BB': 'A#'
        };
        
        // Spanish note names
        const spanishNotes = {
            'C': 'Do', 'C#': 'Do#', 'D': 'Re', 'D#': 'Re#', 'E': 'Mi', 
            'F': 'Fa', 'F#': 'Fa#', 'G': 'Sol', 'G#': 'Sol#', 
            'A': 'La', 'A#': 'La#', 'B': 'Si'
        };
        
        const englishNotes = {
            'Do': 'C', 'Do#': 'C#', 'Re': 'D', 'Re#': 'D#', 'Mi': 'E',
            'Fa': 'F', 'Fa#': 'F#', 'Sol': 'G', 'Sol#': 'G#',
            'La': 'A', 'La#': 'A#', 'Si': 'B'
        };
        
        // Scale definitions (intervals from root)
        const scales = {
            none: [],
            majorPentatonic: [0, 2, 4, 7, 9],
            minorPentatonic: [0, 3, 5, 7, 10],
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            blues: [0, 3, 5, 6, 7, 10],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10],
            harmonic: [0, 2, 3, 5, 7, 8, 11],
            melodic: [0, 2, 3, 5, 7, 9, 11],
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
            // Chord tones
            majorTriad: [0, 4, 7],
            minorTriad: [0, 3, 7],
            powerChord: [0, 7, 12],
            seventh: [0, 4, 7, 10],
            maj7: [0, 4, 7, 11],
            min7: [0, 3, 7, 10],
            // Intervals
            thirds: [0, 3, 4],
            fourths: [0, 5],
            fifths: [0, 7],
            octaves: [0]
        };
        
        // Tuning presets
        const tuningPresets = {
            standard: ['E', 'A', 'D', 'G', 'B', 'E'],
            dropD: ['D', 'A', 'D', 'G', 'B', 'E'],
            dropC: ['C', 'G', 'C', 'F', 'A', 'D'],
            openG: ['D', 'G', 'D', 'G', 'B', 'D'],
            openD: ['D', 'A', 'D', 'F#', 'A', 'D'],
            halfStep: ['D#', 'G#', 'C#', 'F#', 'A#', 'D#'],
            dadgad: ['D', 'A', 'D', 'G', 'A', 'D']
        };
        
        // Canvas setup
        const canvas = document.getElementById('fretboard');
        const ctx = canvas.getContext('2d');
        
        // Fretboard dimensions
        const frets = 22;
        const strings = 6;
        const fretWidth = 65;
        const stringHeight = 45;
        const marginLeft = 80;
        const marginTop = 40;
        const marginRight = 30;
        const marginBottom = 40;
        
        canvas.width = frets * fretWidth + marginLeft + marginRight;
        canvas.height = strings * stringHeight + marginTop + marginBottom;
        
        // State
        let currentTuning = [...tuningPresets.standard];
        let selectedNote = null;
        let selectedScale = 'none';
        let highlightRoots = false;
        let useSpanish = false;
        let invertedView = false; // false = tablature view (1st string on top), true = notation view (6th string on top)
        let selectedPosition = null; // Store the specific clicked position {string, fret}
        let hideExtraRoots = false;
        
        // Helper functions
        function normalizeNote(note) {
            note = note.toUpperCase().trim();
            // Check if it's a Spanish note
            if (englishNotes[note]) {
                note = englishNotes[note];
            }
            return noteAliases[note] || note;
        }
        
        function getNoteIndex(note) {
            note = normalizeNote(note);
            return notes.indexOf(note);
        }
        
        function getNoteAt(stringIndex, fret) {
            const openNote = normalizeNote(currentTuning[stringIndex]);
            const openIndex = getNoteIndex(openNote);
            return notes[(openIndex + fret) % 12];
        }
        
        function getDisplayNote(note) {
            if (useSpanish && spanishNotes[note]) {
                return spanishNotes[note];
            }
            return note;
        }
        
        function getScaleNotes(root, scaleName) {
            if (scaleName === 'none' || !root) return [];
            const rootIndex = getNoteIndex(root);
            const intervals = scales[scaleName];
            return intervals.map(interval => notes[(rootIndex + interval) % 12]);
        }
        
        function getStringPosition(stringIndex) {
            // New behavior: 
            // false (tablature view): 1st string (index 5) at top (position 0), 6th string (index 0) at bottom (position 5)
            // true (notation view): 6th string (index 0) at top (position 0), 1st string (index 5) at bottom (position 5)
            return invertedView ? stringIndex : (5 - stringIndex);
        }
        
        function getStringLabel(stringIndex) {
            // Get the proper string number label
            const stringNumbers = ['6th', '5th', '4th', '3rd', '2nd', '1st'];
            return stringNumbers[stringIndex];
        }
        
        // Drawing functions
        function drawFretboard() {
            // Clear canvas with gradient
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#8b6914');
            gradient.addColorStop(0.5, '#daa520');
            gradient.addColorStop(1, '#b8860b');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw fretboard background
            ctx.fillStyle = '#3e2723';
            ctx.fillRect(marginLeft, marginTop, frets * fretWidth, strings * stringHeight);
            
            // Draw wood grain effect
            ctx.globalAlpha = 0.1;
            for (let i = 0; i < 20; i++) {
                ctx.strokeStyle = '#2e1a17';
                ctx.lineWidth = Math.random() * 3;
                ctx.beginPath();
                ctx.moveTo(marginLeft, marginTop + Math.random() * strings * stringHeight);
                ctx.lineTo(marginLeft + frets * fretWidth, marginTop + Math.random() * strings * stringHeight);
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
            
            // Draw frets
            for (let fret = 0; fret <= frets; fret++) {
                const x = marginLeft + fret * fretWidth;
                
                // Fret wire
                ctx.strokeStyle = '#c0c0c0';
                ctx.lineWidth = fret === 0 ? 6 : 2;
                ctx.beginPath();
                ctx.moveTo(x, marginTop);
                ctx.lineTo(x, marginTop + strings * stringHeight);
                ctx.stroke();
                
                // Fret shadow
                if (fret > 0) {
                    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(x + 1, marginTop);
                    ctx.lineTo(x + 1, marginTop + strings * stringHeight);
                    ctx.stroke();
                }
            }
            
            // Draw strings with gradient
            for (let string = 0; string < strings; string++) {
                const displayPos = getStringPosition(string);
                const y = marginTop + displayPos * stringHeight + stringHeight / 2;
                const thickness = 1 + ((5 - string) * 0.5); // 6th string (index 0) is thickest, 1st string (index 5) is thinnest
                
                // String shadow
                ctx.strokeStyle = 'rgba(0,0,0,0.5)';
                ctx.lineWidth = thickness + 1;
                ctx.beginPath();
                ctx.moveTo(marginLeft, y + 1);
                ctx.lineTo(marginLeft + frets * fretWidth, y + 1);
                ctx.stroke();
                
                // String
                const stringGradient = ctx.createLinearGradient(marginLeft, y, marginLeft + frets * fretWidth, y);
                stringGradient.addColorStop(0, '#e0e0e0');
                stringGradient.addColorStop(0.5, '#ffffff');
                stringGradient.addColorStop(1, '#e0e0e0');
                ctx.strokeStyle = stringGradient;
                ctx.lineWidth = thickness;
                ctx.beginPath();
                ctx.moveTo(marginLeft, y);
                ctx.lineTo(marginLeft + frets * fretWidth, y);
                ctx.stroke();
            }
            
            // Draw position markers
            const markers = [3, 5, 7, 9, 12, 15, 17, 19, 21];
            const doubleMarkers = [12, 24];
            
            markers.forEach(fret => {
                if (fret <= frets) {
                    const x = marginLeft + (fret - 0.5) * fretWidth;
                    
                    if (doubleMarkers.includes(fret)) {
                        // Double dots - centered around the fretboard middle
                        drawInlay(x, marginTop + stringHeight * 2, 10);
                        drawInlay(x, marginTop + stringHeight * 4, 10);
                    } else {
                        // Single dot - centered on fretboard
                        drawInlay(x, marginTop + strings * stringHeight / 2, 10);
                    }
                }
            });
            
            // Draw fret numbers
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            for (let fret = 1; fret <= frets; fret++) {
                const x = marginLeft + (fret - 0.5) * fretWidth;
                ctx.fillText(fret, x, marginTop - 5);
            }
            
            // Draw string names with circles
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            for (let string = 0; string < strings; string++) {
                const displayPos = getStringPosition(string);
                const y = marginTop + displayPos * stringHeight + stringHeight / 2;
                
                // Circle background
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.beginPath();
                ctx.arc(marginLeft - 35, y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // String name
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 16px Arial';
                const displayNote = getDisplayNote(currentTuning[string]);
                ctx.fillText(displayNote, marginLeft - 35, y);
                
                // String number
                ctx.font = '12px Arial';
                const stringLabel = getStringLabel(string);
                ctx.fillText(stringLabel, marginLeft - 35, y + 25);
            }
        }
        
        function drawInlay(x, y, radius) {
            // Pearl inlay effect
            const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
            gradient.addColorStop(0, '#f0f0f0');
            gradient.addColorStop(0.5, '#e0e0e0');
            gradient.addColorStop(1, '#d0d0d0');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Inner shadow
            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(x, y, radius - 1, 0, Math.PI * 2);
            ctx.stroke();
        }
        
        function drawNotes() {
            const scaleNotes = getScaleNotes(selectedNote, selectedScale);
            
            for (let string = 0; string < strings; string++) {
                const displayPos = getStringPosition(string);
                
                for (let fret = 0; fret <= frets; fret++) {
                    const note = getNoteAt(string, fret);
                    let shouldDraw = false;
                    let color = '#333';
                    let size = 16;
                    let isRoot = false;
                    let isSelectedPosition = selectedPosition && 
                        selectedPosition.string === string && selectedPosition.fret === fret;
                    
                    // Determine if and how to draw this note
                    if (selectedNote && note === selectedNote) {
                        // This is a root note position
                        if (selectedScale !== 'none') {
                            // We're viewing a scale/mode/progression
                            if (isSelectedPosition) {
                                // This is the originally clicked position - always show as main root
                                shouldDraw = true;
                                color = '#ffeb3b';
                                size = 20;
                                isRoot = true;
                            } else if (hideExtraRoots) {
                                // For other root positions, show as blue scale notes (since root is always part of its own scale)
                                shouldDraw = true;
                                color = '#64b5f6';
                                size = 16;
                            } else {
                                // Normal behavior - show all roots as roots
                                shouldDraw = true;
                                color = '#ffeb3b';
                                size = 20;
                                isRoot = true;
                            }
                        } else {
                            // No scale selected - free play mode
                            shouldDraw = true;
                            color = '#ff5252';
                            size = 18;
                            if (highlightRoots) {
                                color = '#4caf50';
                            }
                        }
                    } else if (scaleNotes.includes(note)) {
                        // This is a non-root scale note
                        shouldDraw = true;
                        color = '#64b5f6';
                    }
                    
                    if (shouldDraw) {
                        const x = marginLeft + (fret === 0 ? 0 : (fret - 0.5) * fretWidth);
                        const y = marginTop + displayPos * stringHeight + stringHeight / 2;
                        
                        // Draw note circle with gradient
                        const gradient = ctx.createRadialGradient(x, y, 0, x, y, size);
                        gradient.addColorStop(0, color);
                        gradient.addColorStop(0.7, color);
                        gradient.addColorStop(1, shadeColor(color, -30));
                        
                        ctx.fillStyle = gradient;
                        ctx.beginPath();
                        ctx.arc(x, y, size, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Add glow effect for root notes
                        if (isRoot) {
                            ctx.shadowBlur = 20;
                            ctx.shadowColor = color;
                            ctx.fillStyle = gradient;
                            ctx.beginPath();
                            ctx.arc(x, y, size, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.shadowBlur = 0;
                        }
                        
                        // Draw note name
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        const displayNote = getDisplayNote(note);
                        ctx.fillText(displayNote, x, y);
                        
                        // Add position indicator for non-root selected notes
                        if (selectedNote && note === selectedNote && !isRoot && selectedScale === 'none') {
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.arc(x, y, size + 4, 0, Math.PI * 2);
                            ctx.stroke();
                        }
                    }
                }
            }
        }
        
        function shadeColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        function draw() {
            drawFretboard();
            drawNotes();
        }
        
        function updateScaleInfo() {
            const scaleInfo = document.getElementById('scaleInfo');
            if (selectedNote && selectedScale !== 'none') {
                const scaleNotes = getScaleNotes(selectedNote, selectedScale);
                const displayNotes = scaleNotes.map(note => getDisplayNote(note)).join(' - ');
                const rootDisplay = getDisplayNote(selectedNote);
                const scaleName = document.querySelector(`#scaleSelect option[value="${selectedScale}"]`).textContent;
                
                scaleInfo.innerHTML = `<strong>${rootDisplay} ${scaleName}:</strong> ${displayNotes}`;
                scaleInfo.style.display = 'block';
            } else {
                scaleInfo.style.display = 'none';
            }
        }
        
        function updateViewLabels() {
            const tuningLabel = document.getElementById('tuningLabel');
            const invertButton = document.getElementById('invertFretboard');
            
            if (invertedView) {
                tuningLabel.textContent = '6th→1st string';
                invertButton.textContent = 'Tablature View';
            } else {
                tuningLabel.textContent = '1st→6th string';
                invertButton.textContent = 'Notation View';
            }
        }
        
        // Event handlers
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            // Calculate which fret was clicked
            let fret = Math.round((x - marginLeft) / fretWidth);
            if (x < marginLeft + fretWidth * 0.5) {
                fret = 0;
            } else {
                fret = Math.round((x - marginLeft + fretWidth * 0.5) / fretWidth);
            }
            
            // Calculate which visual string position was clicked
            const visualStringPos = Math.floor((y - marginTop) / stringHeight);
            
            // Convert visual position to actual string index
            const string = invertedView ? visualStringPos : (5 - visualStringPos);
            
            if (fret >= 0 && fret <= frets && string >= 0 && string < strings) {
                selectedNote = getNoteAt(string, fret);
                selectedPosition = { string: string, fret: fret }; // Store the clicked position
                
                // Update info display
                const noteDisplay = document.getElementById('selectedNote');
                const infoDisplay = document.getElementById('noteInfo');
                
                const displayNote = getDisplayNote(selectedNote);
                noteDisplay.textContent = displayNote;
                noteDisplay.classList.add('pulse');
                setTimeout(() => noteDisplay.classList.remove('pulse'), 500);
                
                const stringName = getStringLabel(string);
                const positions = [];
                
                // Find all positions of this note
                for (let s = 0; s < strings; s++) {
                    for (let f = 0; f <= frets; f++) {
                        if (getNoteAt(s, f) === selectedNote) {
                            positions.push(`${getStringLabel(s)} string, fret ${f}`);
                        }
                    }
                }
                
                infoDisplay.innerHTML = `
                    <strong>Clicked:</strong> ${stringName} string, fret ${fret}<br>
                    <strong>Found ${positions.length} positions</strong> across the fretboard<br>
                    <em>This note is now the root for any scale you select</em>
                `;
                
                updateScaleInfo();
                draw();
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            // Check if hovering over fretboard area
            if (x >= marginLeft && x <= marginLeft + frets * fretWidth &&
                y >= marginTop && y <= marginTop + strings * stringHeight) {
                canvas.style.cursor = 'pointer';
            } else {
                canvas.style.cursor = 'default';
            }
        });
        
        document.getElementById('tuningPreset').addEventListener('change', (e) => {
            const preset = e.target.value;
            if (preset !== 'custom') {
                currentTuning = [...tuningPresets[preset]];
                // Update input fields
                for (let i = 0; i < 6; i++) {
                    document.getElementById(`string${i + 1}`).value = currentTuning[5 - i];
                }
                draw();
            }
        });
        
        // Custom tuning inputs
        for (let i = 1; i <= 6; i++) {
            document.getElementById(`string${i}`).addEventListener('input', (e) => {
                const note = normalizeNote(e.target.value);
                if (note && notes.includes(note)) {
                    currentTuning[6 - i] = note;
                    document.getElementById('tuningPreset').value = 'custom';
                    draw();
                }
            });
        }
        
        document.getElementById('scaleSelect').addEventListener('change', (e) => {
            selectedScale = e.target.value;
            updateScaleInfo();
            draw();
        });
        
        document.getElementById('clearButton').addEventListener('click', () => {
            selectedNote = null;
            selectedPosition = null;
            selectedScale = 'none';
            document.getElementById('scaleSelect').value = 'none';
            document.getElementById('selectedNote').textContent = 'Click any fret to explore';
            document.getElementById('noteInfo').innerHTML = 'Click a note to set it as the root for scales';
            updateScaleInfo();
            draw();
        });
        
        document.getElementById('highlightRoots').addEventListener('click', () => {
            highlightRoots = !highlightRoots;
            document.getElementById('highlightRoots').textContent = 
                highlightRoots ? 'Hide Root Octaves' : 'Highlight Roots';
            draw();
        });
        
        document.getElementById('hideExtraRoots').addEventListener('click', () => {
            hideExtraRoots = !hideExtraRoots;
            document.getElementById('hideExtraRoots').textContent = 
                hideExtraRoots ? 'Show All Roots' : 'Hide Extra Roots';
            draw();
        });
        
        document.getElementById('languageToggle').addEventListener('click', () => {
            useSpanish = !useSpanish;
            document.getElementById('languageToggle').textContent = useSpanish ? 'English' : 'Español';
            updateScaleInfo();
            draw();
        });
        
        document.getElementById('invertFretboard').addEventListener('click', () => {
            invertedView = !invertedView;
            updateViewLabels();
            draw();
        });
        
        // Modal functions
        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }
        
        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = (e) => {
            const modal = document.getElementById('helpModal');
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        };
        
        // Initial setup
        updateViewLabels();
        draw();
    </script>
</body>
</html>